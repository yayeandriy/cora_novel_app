<main class="dashboard-main" (click)="closeAllMenus()">
<section class="dashboard-section">
  <!-- Loading state -->
  @if (isLoading()) {
  <div class="loading-container">
    <div class="animate-spin h-8 w-8 border-b-2 border-gray-900"></div>
  </div>
  } @else {
  <!-- Fixed 4x3 grid that fills the screen -->
  <div class="dashboard-grid">
    @for (cell of getGridCells(); track cell.index) {
      @if (cell.project) {
        <!-- Project Card -->
        <div class="card card-project"
             [class.archived]="isArchived(cell.project)"
             [class.confirming]="confirmingArchive() === cell.project.id"
             (click)="openProject(cell.project)"
             (contextmenu)="onProjectContextMenu(cell.project, $event)">
          
          @if (confirmingArchive() === cell.project.id) {
            <!-- Inline Archive Confirmation -->
            <div class="confirm-overlay" (click)="$event.stopPropagation()">
              <div class="confirm-message">
                <span>Archive "{{ cell.project.name }}"?</span>
                <div class="confirm-actions">
                  <button class="confirm-btn confirm-yes" (click)="confirmArchiveAction(cell.project, $event)">Archive</button>
                  <button class="confirm-btn confirm-no" (click)="cancelArchive($event)">Cancel</button>
                </div>
              </div>
            </div>
          } @else if (confirmingDelete() === cell.project.id) {
            <!-- Inline Delete Confirmation -->
            <div class="confirm-overlay" (click)="$event.stopPropagation()">
              <div class="confirm-message">
                <span>Delete "{{ cell.project.name }}"?</span>
                <div class="confirm-actions">
                  <button class="confirm-btn confirm-yes" (click)="confirmDeleteAction(cell.project.id, $event)">Delete</button>
                  <button class="confirm-btn confirm-no" (click)="cancelDelete($event)">Cancel</button>
                </div>
              </div>
            </div>
          }
          
          <div class="card-title">
            <h3>{{ cell.project.name }}</h3>
            @if (isArchived(cell.project)) {
              <span class="archived-badge">Archived</span>
            }
          </div>
          <div class="card-pages">
            @if (isArchived(cell.project) && showArchivedProjects()) {
              <!-- Archived project in show archived mode -->
              <div class="card-info">
                <span>{{ getStats(cell.project.id).pageCount + ' ' + (getStats(cell.project.id).pageCount === 1 ? 'page' : 'pages') }}</span>
                <button class="archive-action-btn"
                        (click)="unarchiveProject(cell.project, $event)"
                        title="Unarchive project">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="17 1 21 5 17 9"/>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                    <polyline points="7 23 3 19 7 15"/>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                  </svg>
                </button>
              </div>
              <div class="card-actions">
                <button class="delete-project-btn"
                        (click)="deleteProject(cell.project.id, $event)">
                  Delete project
                </button>
              </div>
            } @else if (getStats(cell.project.id).pageCount === 0) {
              <!-- Empty project - show only delete -->
              <div class="card-actions">
                <button class="delete-project-btn"
                        (click)="deleteProject(cell.project.id, $event)">
                  Delete project
                </button>
              </div>
            } @else {
              <!-- Regular project with pages -->
              <div class="card-info">
                <span>{{ getStats(cell.project.id).pageCount + ' ' + (getStats(cell.project.id).pageCount === 1 ? 'page' : 'pages') }}</span>
                <button class="archive-action-btn"
                        (click)="archiveProject(cell.project, $event)"
                        title="Archive project">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="21 8 21 21 3 21 3 8"/>
                    <rect x="1" y="3" width="22" height="5"/>
                    <line x1="10" y1="12" x2="14" y2="12"/>
                  </svg>
                </button>
              </div>
            }
          </div>
        </div>
      } @else if (showCreate() && cell.index === editingCellIndex()) {
        <!-- New Project Card (inline edit) -->
        <div class="card card-project card-editing">
          <div class="card-title">
            <div class="inline-edit-wrapper">
              <input #newProjectInput
                     type="text"
                     [formControl]="nameControl"
                     class="inline-title-input"
                     placeholder="Title of the story"
                     (keydown.enter)="createQuick()"
                     (keydown.escape)="cancelEdit()"
                     (blur)="onInputBlur()" />
            </div>
          </div>
          <div class="card-pages">
            <span>No pages</span>
          </div>
        </div>
      } @else {
        <!-- Empty Card -->
        <div class="card card-empty">
          @if (importingCellIndex() === cell.index) {
            <!-- Inline Import Options -->
            <div class="import-overlay" (click)="$event.stopPropagation()">
              <div class="import-message">
                <span class="import-header">Import story</span>
                <div class="import-options">
                  <button class="import-option-btn" (click)="importFromFolder()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <div class="import-option-text">
                      <span class="import-option-title">From folder</span>
                      <span class="import-option-desc">Subfolders as chapters</span>
                    </div>
                  </button>
                  <button class="import-option-btn" (click)="importFromExport()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <div class="import-option-text">
                      <span class="import-option-title">From export</span>
                      <span class="import-option-desc">With all metadata</span>
                    </div>
                  </button>
                </div>
                <button class="import-cancel-btn" (click)="cancelImport($event)">Cancel</button>
              </div>
            </div>
          }
          <div class="empty-cell-actions">
            <button class="empty-cell-btn" (click)="startCreateAt(cell.index)" title="Create new project">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
            </button>
            <button class="empty-cell-btn" (click)="toggleEmptyCellImportMenu(cell.index, $event)" title="Import story">
              <img src="assets/icons/square.and.arrow.down.svg" alt="Import" width="24" height="24" />
            </button>
          </div>
        </div>
      }
    }
  </div>
  }
  
  <!-- Bottom Dock - Only show if there are archived projects -->
  @if (shouldShowDock()) {
    <div class="bottom-dock">
      <!-- Archive Filter Toggle -->
      @if (hasArchivedProjects()) {
        <button class="dock-button" 
                [class.active]="showArchivedProjects()"
                (click)="toggleShowArchived()" 
                title="Toggle archived projects">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="21 8 21 21 3 21 3 8"/>
            <rect x="1" y="3" width="22" height="5"/>
            <line x1="10" y1="12" x2="14" y2="12"/>
          </svg>
          <span>{{ showArchivedProjects() ? 'Hide Archived' : 'Show Archived' }}</span>
        </button>
      }
    </div>
  }
</section>
</main>
