<div class="project-view">
  <!-- Header with Timeline (hidden by default, full-width timeline when visible) -->
  @if (timelineHeaderVisible) {
    <header class="w-full flex">
      <div class="w-full grow">
        <app-project-timeline
          [projectId]="projectId"
          [projectName]="projectName"
          [startDate]="timelineStart"
          [endDate]="timelineEnd"
          [selectedDocId]="selectedDoc?.id"
          (timelineUpdated)="onTimelineUpdated($event)"
          (docTimelineClick)="onDocTimelineClick($event)"
          (docIntervalClick)="onDocIntervalClick($event)">
        </app-project-timeline>
      </div>
    </header>
  }


  <!-- Main content area -->
  <div class="content-wrapper">
    <!-- Left Sidebar -->
    @if (!leftCollapsed) {
    <app-doc-tree 
      [docGroups]="docGroups"
      [selectedDoc]="selectedDoc"
      [selectedGroup]="selectedGroup"
      [projectName]="projectName"
      [editingProjectName]="editingProjectName"
      [(projectNameEdit)]="projectNameEdit"
      [groupsWithDrafts]="groupsWithDrafts"
      [docsWithDrafts]="docsWithDrafts"
      [style.width.px]="leftWidth"
      (groupSelected)="selectGroup($event.group, $event.event)"
      (docSelected)="selectDoc($event)"
      (groupToggled)="toggleGroup($event)"
      (groupCreated)="createGroup()"
      (docCreatedInGroup)="createDocInGroup($event)"
      (importFoldersRequested)="onImportFoldersRequested()"
      (importFilesRequested)="onImportFilesRequested()"
      (exportProjectRequested)="onExportProjectRequested()"
      (treeKeyDown)="handleTreeKeyDown($event)"
      (widthChanged)="startResizeLeft($event)"
      (collapseToggle)="toggleLeftSidebar()"
      (projectNameEditStart)="startEditProjectName($event)"
      (projectNameSave)="saveProjectName()"
      (projectNameKeydown)="onProjectNameKeydown($event)"
      (backClicked)="goBack()">
    </app-doc-tree>
    } @else {
      <div class="collapsed-handle collapsed-left" (mousedown)="startDragExpandLeft($event)" title="Drag to expand">
        <span class="divider-grip"></span>
      </div>
    }

    <!-- Editor -->
    <main class="editor-area">
      <!-- Project title moved to the middle section on top of the doc header -->
      <div class="project-title-bar" (click)="onProjectHeaderClick($event)">
        <div class="project-title-center">
          @if (!editingProjectName) {
            <div class="project-name">
              <span class="cursor-text" title="Click to rename" (click)="startEditProjectName($event)">{{ projectName }}</span>
            </div>
          } @else {
            <input
              #projectNameInput
              class="project-name-input"
              [(ngModel)]="projectNameEdit"
              (blur)="saveProjectName()"
              (keydown)="onProjectNameKeydown($event)"
              placeholder="Project name" />
          }
          <div class="drafts-row">
            @if (projectDraftsExpanded) {
              <div class="drafts-list">
                @for (pd of projectDrafts; track pd.id) {
                  <div class="draft-chip" [class.active]="selectedProjectDraftId === pd.id" (click)="onProjectDraftChipClick(pd, $event)" (dblclick)="startEditProjectDraft(pd)" title="Click to select, double-click to rename">
                    @if (editingProjectDraftId === pd.id) {
                      <input class="draft-name-input"
                             [(ngModel)]="projectDraftNameEdit"
                             (blur)="saveProjectDraftName()"
                             (keydown.enter)="saveProjectDraftName()"
                             (keydown.escape)="cancelProjectDraftEdit()"
                             placeholder="Draft name" />
                      <button class="draft-delete-btn" title="Delete draft" (click)="deleteProjectDraft(pd.id); $event.stopPropagation();">ðŸ—‘</button>
                    } @else {
                      <span class="draft-name">{{ pd.name }}</span>
                    }
                  </div>
                }
                <button class="draft-add-btn" (click)="createProjectDraft()" aria-label="Add project draft" title="Add draft">
                  <svg class="icon-plus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 5a1 1 0 1 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z"/>
                  </svg>
                </button>
              </div>
            }
            <button class="drafts-toggle toggle-uniform" (click)="toggleProjectDrafts()" [class.active]="projectDraftsExpanded" aria-label="Project drafts" title="Project drafts">
              @if (projectDraftsCount > 0) {
                <span class="drafts-count">{{ projectDraftsCount }}</span>
              } @else {
                <svg class="icon-drafts" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 7h10a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2zm0-2a2 2 0 0 0-2 2v1h12a2 2 0 0 1 2 2V7a2 2 0 0 0-2-2H7z"/>
                </svg>
              }
            </button>
          </div>
        </div>
      </div>

      @if (projectHeaderExpanded && projectData) {
        <div class="header-notes">
          <textarea class="header-notes-textarea"
                    [persistTextareaHeight]="'pv:notes:project:' + projectId"
                    [(ngModel)]="projectData.notes"
                    (input)="onProjectNotesChange()"
                    placeholder="Add project notes..."></textarea>
        </div>
      }

      <!-- Folder name row (under project name) -->
      @if (selectedGroup || currentGroup) {
      <div class="folder-title-bar" (click)="onFolderHeaderClick($event)">
        <div class="folder-title-center">
          @if (getFolderIndexLabel()) { <span class="header-index" style="margin-right: 1rem;">{{ getFolderIndexLabel() }}.</span> }
          @if (!editingFolderName) {
            <div class="project-name">
              <span class="cursor-text" title="Click to rename folder" (click)="startEditFolderName($event)">{{ (selectedGroup || currentGroup)?.name }}</span>
            </div>
          } @else {
            <input
              #folderNameInput
              class="project-name-input folder-name-input"
              [(ngModel)]="folderNameEdit"
              (blur)="saveFolderName()"
              (keydown)="onFolderNameKeydown($event)"
              placeholder="Folder name" />
          }
          <div class="drafts-row">
            @if (folderDraftsExpanded) {
              <div class="drafts-list">
                @for (fd of folderDrafts; track fd.id) {
                  <div class="draft-chip" [class.active]="selectedFolderDraftId === fd.id" (click)="onFolderDraftChipClick(fd, $event)" (dblclick)="startEditFolderDraft(fd)" title="Click to select, double-click to rename">
                    @if (editingFolderDraftId === fd.id) {
                      <input class="draft-name-input"
                             [(ngModel)]="folderDraftNameEdit"
                             (blur)="saveFolderDraftName()"
                             (keydown.enter)="saveFolderDraftName()"
                             (keydown.escape)="cancelFolderDraftEdit()"
                             placeholder="Draft name" />
                      <button class="draft-delete-btn" title="Delete draft" (click)="deleteFolderDraft(fd.id); $event.stopPropagation();">ðŸ—‘</button>
                    } @else {
                      <span class="draft-name">{{ fd.name }}</span>
                    }
                  </div>
                }
                <button class="draft-add-btn" (click)="createFolderDraft()" aria-label="Add folder draft" title="Add draft">
                  <svg class="icon-plus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 5a1 1 0 1 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z"/>
                  </svg>
                </button>
              </div>
            }
            <button class="drafts-toggle toggle-uniform" (click)="toggleFolderDrafts()" [class.active]="folderDraftsExpanded" aria-label="Folder drafts" title="Folder drafts">
              @if (folderDraftsCount > 0) {
                <span class="drafts-count">{{ folderDraftsCount }}</span>
              } @else {
                <svg class="icon-drafts" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 7h10a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2zm0-2a2 2 0 0 0-2 2v1h12a2 2 0 0 1 2 2V7a2 2 0 0 0-2-2H7z"/>
                </svg>
              }
            </button>
          </div>
        </div>
      </div>
      @if (folderHeaderExpanded && (selectedGroup || currentGroup)) {
        <div class="header-notes">
          <textarea class="header-notes-textarea"
                    [persistTextareaHeight]="'pv:notes:folder:' + projectId"
                    [(ngModel)]="folderNotes"
                    (input)="onDocGroupNotesChange()"
                    placeholder="Add folder notes..."></textarea>
        </div>
      }
      }
      <!-- Document editor -->
      @if (selectedDoc && !selectedGroup) {
      <app-document-editor 
        [selectedDoc]="selectedDoc"
        [allProjectDocs]="getAllDocs()"
        [showSaveStatus]="showSaveStatus"
        [hasUnsavedChanges]="hasUnsavedChanges"
        [drafts]="drafts"
        [draftSyncStatus]="draftSyncStatus"
        [selectedDraftId]="selectedDraftId"
    [externalMode]="selectedFolderDraftId != null || selectedProjectDraftId != null"
    [externalDraftId]="selectedFolderDraftId ?? selectedProjectDraftId"
  [externalDraftName]="selectedFolderDraftId ? (getSelectedFolderDraftName() ?? 'Draft') : (selectedProjectDraftId ? (getSelectedProjectDraftName() ?? 'Draft') : null)"
    [externalDraftContent]="selectedFolderDraftId ? getFolderDraftLocalContent(selectedFolderDraftId) : (selectedProjectDraftId ? getProjectDraftLocalContent(selectedProjectDraftId) : '')"
        [docIndexLabel]="getDocIndexLabel()"
        (docNameChange)="renameDoc($event)"
        (docTextChange)="onDocumentTextChange()"
        (docSaved)="saveDoc()"
        (draftRenamed)="onDocumentDraftRenamed($event)"
        (draftAdd)="onDocumentDraftAdd()"
        (draftSelect)="onDocumentDraftSelect($event)"
        (draftChanged)="onDocumentDraftChanged($event)"
        (draftBlurred)="onDocumentDraftBlurred($event)"
        (draftDeleted)="deleteDraft($event)">
      </app-document-editor>
      }

      <!-- Group view -->
      @if (selectedGroup && !selectedDoc) {
      <app-group-view 
        [selectedGroup]="selectedGroup"
        [selectedFolderDraftId]="selectedFolderDraftId"
        [selectedFolderDraftContent]="selectedFolderDraftId ? getFolderDraftLocalContent(selectedFolderDraftId) : ''"
        (folderDraftChanged)="onFolderDraftChange($event.draftId, $event.content, $event.cursorPosition)"
        (folderDraftBlurred)="onFolderDraftBlur($event)"
        (groupNameChange)="renameGroup($event)"
        (createDocRequested)="createDoc()"
        (focusTreeRequested)="focusTree()"
        (notesChanged)="onDocGroupNotesChange()">
      </app-group-view>
      }
      
      <!-- Empty state -->
      @if (!selectedDoc && !selectedGroup) {
      <div class="editor-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" class="empty-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="empty-message">No document selected</p>
        <p class="empty-hint">Create a folder and add documents to start writing</p>
      </div>
      }
    </main>

    <!-- Right Sidebar -->
  @if (!rightCollapsed) {
  <app-right-sidebar
      [selectedDoc]="selectedDoc"
      [selectedDocGroup]="selectedGroup || currentGroup"
      [project]="projectData"
      [characters]="characters"
      [docCharacterIds]="docCharacterIds"
      [docGroupCharacterIds]="docGroupCharacterIds"
      [events]="events"
      [drafts]="drafts"
      [draftSyncStatus]="draftSyncStatus"
      [charactersExpanded]="charactersExpanded"
      [eventsExpanded]="eventsExpanded"
      [notesExpanded]="notesExpanded"
      [draftsExpanded]="draftsExpanded"
      [timelineHeaderVisible]="timelineHeaderVisible"
  [editingCharacterId]="editingCharacterId"
  [docEventIds]="docEventIds"
  [docGroupEventIds]="docGroupEventIds"
  [editingEventId]="editingEventId"
      [style.width.px]="rightWidth"
      (charactersExpandedChange)="charactersExpanded = $event"
      (eventsExpandedChange)="eventsExpanded = $event"
      (notesExpandedChange)="notesExpanded = $event"
      (draftsExpandedChange)="draftsExpanded = $event"
  (collapseToggle)="toggleRightSidebar()"
      (timelineHeaderToggle)="toggleTimelineHeader()"
    (charactersReorder)="onSidebarCharactersReorder($event)"
    (eventsReorder)="onSidebarEventsReorder($event)"
  (characterUpdate)="onSidebarCharacterUpdate($event)"
      (characterAdd)="onSidebarCharacterAdd()"
      (characterCreate)="onSidebarCharacterCreate($event)"
      (characterNameChange)="onSidebarCharacterNameChange($event)"
      (characterDescChange)="onSidebarCharacterDescChange($event)"
      (characterDelete)="onSidebarCharacterDelete($event)"
      (characterToggle)="onSidebarCharacterToggle($event)"
      (docGroupCharacterToggle)="onSidebarDocGroupCharacterToggle($event)"
  (eventAdd)="onSidebarEventAdd()"
      (eventCreate)="onSidebarEventCreate($event)"
  (eventUpdate)="onSidebarEventUpdate($event)"
  (eventDelete)="onSidebarEventDelete($event)"
  (eventToggle)="onSidebarEventToggle($event)"
      (docGroupEventToggle)="onSidebarDocGroupEventToggle($event)"
      (docNotesChanged)="onDocumentNotesChange()"
      (docGroupNotesChanged)="onDocGroupNotesChange()"
      (projectNotesChanged)="onProjectNotesChange()"
      (draftCreated)="createDraft()"
      (draftChanged)="onDraftChange($event.draftId, $event.content, $event.cursorPosition)"
      (draftBlurred)="onDraftBlur($event)"
      (draftDeleted)="deleteDraft($event)"
      (draftContentRequested)="getDraftLocalContent($event)"
      (widthChanged)="startResizeRight($event)">
    </app-right-sidebar>
  } @else {
    <div class="collapsed-handle collapsed-right" (mousedown)="startDragExpandRight($event)" title="Drag to expand">
      <span class="divider-grip"></span>
    </div>
  }
  </div>

  <!-- Import target folder dialog -->
  @if (showImportDialog) {
    <div class="modal-overlay" (click)="cancelImport()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">Import text files</div>
        <div class="modal-body">
          <div class="mb-2 text-sm text-gray-600">Choose a folder to place the imported documents.</div>
          <select class="modal-select" [(ngModel)]="importTargetGroupId">
            @for (opt of flattenedGroups; track opt.id) {
              <option [ngValue]="opt.id">{{ opt.label }}</option>
            }
          </select>
          @if (pendingImportFiles.length) {
            <div class="mt-3 text-xs text-gray-500">{{ pendingImportFiles.length }} file(s) selected</div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="cancelImport()">Cancel</button>
          <button class="btn-primary" [disabled]="!importTargetGroupId" (click)="confirmImport()">Import</button>
        </div>
      </div>
    </div>
  }
  <!-- Global footer component -->
  <app-footer
    [selectedDoc]="selectedDoc"
    [allDocs]="getAllDocs()"
    [editorWidthPct]="editorWidthPct"
    (createGroup)="createGroup()"
    (importFolders)="onImportFoldersRequested()"
    (importFiles)="onImportFilesRequested()"
    (exportProject)="onExportProjectRequested()"
    (editorWidthPctChange)="onFooterEditorWidthChange($event)"
  ></app-footer>
</div>
