<div class="project-view">
  <!-- Floating logo button -->
  @if (!leftCollapsed) {
    <button class="floating-logo" title="Back to dashboard" (click)="goBack()">
      <img src="assets/logo.svg" alt="Cora" />
    </button>
  }

  <!-- Floating doc tools (overlays Notes/Storyline panels) -->
  @if (selectedDoc && !selectedGroup) {
    <div class="floating-doc-tools">
      <!-- Storyline + Notes button group -->
      <div class="button-group">
        <!-- Storyline button -->
        <button class="toolbar-button toggle-labeled" (click)="toggleDocCardsView()" [class.active]="projectHeaderExpanded" aria-label="Storyline" title="Storyline - Project overview">
          <svg class="icon-cards" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4h4v4H4V4zm6 0h4v4h-4V4zm6 0h4v4h-4V4zM4 10h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4zM4 16h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4z"/>
          </svg>
          <span class="tool-label">Storyline</span>
        </button>
        
        <!-- Notes button -->
        <button class="toolbar-button toggle-labeled" (click)="onFolderHeaderClick()" [class.active]="folderHeaderExpanded" aria-label="Notes" title="Notes - Folder notes">
          @if (folderDraftsCount > 0) {
            <span class="count-circle">{{ folderDraftsCount }}</span>
          }
          <span class="tool-label">Notes</span>
        </button>
      </div>
      
      <!-- Drafts button (separate) -->
      <button class="toolbar-button toggle-labeled" (click)="documentEditorComponent?.toggleDraftControls()" [class.active]="documentEditorComponent && !documentEditorComponent.isSplitCollapsed" aria-label="Drafts" title="Drafts - Document drafts">
        @if (drafts.length > 0) {
          <span class="count-circle">{{ drafts.length }}</span>
        }
        <span class="tool-label">Drafts</span>
      </button>
    </div>
  }

  <!-- Storyline panel (project doc cards) -->
  @if (projectHeaderExpanded) {
    <div class="floating-storyline-panel" (click)="$event.stopPropagation()">
      <!-- Only show folders list when there are multiple parts -->
      @if (docGroups.length > 1) {
        <div class="folders-scroll-container">
          @for (group of docGroups; track group.id; let i = $index) {
            <button 
              class="folder-chip" 
              [class.selected]="projectHeaderSelectedGroupId === group.id"
              (click)="onProjectFolderChipClick(group, $event)">
              <span class="folder-chip-index">{{ i + 1 }}.</span>
              <span class="folder-chip-name">{{ group.name }}</span>
            </button>
          }
        </div>
      }
      @if (docGroups.length === 0) {
        <div class="folders-scroll-container">
          <span class="no-folders-hint">No folders yet</span>
        </div>
      }
      <!-- Docs cards for selected folder -->
      @if (projectHeaderSelectedGroupId) {
        <div class="folder-docs-row">
          <div class="docs-cards-container" (wheel)="onDocsContainerWheel($event)">
            @for (doc of getProjectHeaderSelectedGroupDocs(); track doc.id; let j = $index) {
              <div class="doc-card" [class.selected]="projectHeaderHighlightedDocId === doc.id" (click)="onProjectDocCardClick(doc, $event)">
                <div class="doc-card-header">
                  <span class="doc-card-index">{{ j + 1 }}.</span>
                  <span class="doc-card-name">{{ doc.name }}</span>
                </div>
                <div class="doc-card-metadata">
                  <!-- Characters row -->
                  <app-metadata-chips
                    [items]="getProjectHeaderDocCharacters(doc.id)"
                    [availableItems]="getAvailableCharactersForDoc(doc.id)"
                    [allItems]="characters"
                    type="character"
                    placeholder="New character..."
                    (remove)="removeCharacterFromDocCard(doc.id, $event)"
                    (add)="addCharacterToDocCard(doc.id, $event)"
                    (create)="createAndAddCharacterToDoc(doc.id, $event)"
                    (deleteItem)="onSidebarCharacterDelete($event)"
                    (editItem)="onInlineCharacterEdit($event)"
                    (reorder)="reorderDocCardCharacters(doc.id, $event)">
                  </app-metadata-chips>

                  <!-- Events row -->
                  <app-metadata-chips
                    [items]="getProjectHeaderDocEvents(doc.id)"
                    [availableItems]="getAvailableEventsForDoc(doc.id)"
                    [allItems]="events"
                    type="event"
                    placeholder="New event..."
                    (remove)="removeEventFromDocCard(doc.id, $event)"
                    (add)="addEventToDocCard(doc.id, $event)"
                    (create)="createAndAddEventToDoc(doc.id, $event)"
                    (deleteItem)="onSidebarEventDelete($event)"
                    (editItem)="onInlineEventEdit($event)"
                    (reorder)="reorderDocCardEvents(doc.id, $event)">
                  </app-metadata-chips>

                  <!-- Places row -->
                  <app-metadata-chips
                    [items]="getProjectHeaderDocPlaces(doc.id)"
                    [availableItems]="getAvailablePlacesForDoc(doc.id)"
                    [allItems]="places"
                    type="place"
                    placeholder="New place..."
                    (remove)="removePlaceFromDocCard(doc.id, $event)"
                    (add)="addPlaceToDocCard(doc.id, $event)"
                    (create)="createAndAddPlaceToDoc(doc.id, $event)"
                    (deleteItem)="onSidebarPlaceDelete($event)"
                    (editItem)="onInlinePlaceEdit($event)"
                    (reorder)="reorderDocCardPlaces(doc.id, $event)">
                  </app-metadata-chips>
                </div>
              </div>
            }
            @if (getProjectHeaderSelectedGroupDocs().length === 0) {
              <span class="no-docs-hint">No documents in this folder</span>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Notes panel (folder drafts) -->
  @if (folderHeaderExpanded && (selectedGroup || currentGroup)) {
    <div class="floating-notes-panel" (click)="$event.stopPropagation()">
      <app-folder-drafts
        [drafts]="folderDrafts"
        [selectedDraftId]="selectedFolderDraftId"
        (draftCreate)="createFolderDraft()"
        (draftChange)="onFolderDraftChange($event.draftId, $event.content, $event.cursorPosition)"
        (draftNameChange)="onFolderDraftNameChange($event.draftId, $event.name)"
        (draftDelete)="deleteFolderDraft($event)"
        (draftMove)="onFolderDraftMove($event)"
        (draftSelect)="onFolderDraftSelect($event)">
      </app-folder-drafts>
    </div>
  }

  <!-- Header with Timeline (hidden by default, full-width timeline when visible) -->
  @if (timelineHeaderVisible) {
    <header class="w-full flex">
      <div class="w-full grow">
        <app-project-timeline
          [projectId]="projectId"
          [projectName]="projectName"
          [startDate]="timelineStart"
          [endDate]="timelineEnd"
          [selectedDocId]="selectedDoc?.id"
          (timelineUpdated)="onTimelineUpdated($event)"
          (docTimelineClick)="onDocTimelineClick($event)"
          (docIntervalClick)="onDocIntervalClick($event)">
        </app-project-timeline>
      </div>
    </header>
  }


  <!-- Main content area -->
  <div class="content-wrapper">
    <!-- Left Sidebar -->
    <div class="sidebar-container left-sidebar" [style.width.px]="leftCollapsed ? 6 : leftWidth">
      <div class="sidebar-inner" [style.width.px]="leftWidth">
        @if (!leftCollapsed) {
        <app-doc-tree 
          [docGroups]="docGroups"
          [selectedDoc]="selectedDoc"
          [selectedGroup]="selectedGroup"
          [projectName]="projectName"
          [editingProjectName]="editingProjectName"
          [projectNameEdit]="projectNameEdit"
          (projectNameEditChange)="projectNameEdit = $event"
          [groupsWithDrafts]="groupsWithDrafts"
          [docsWithDrafts]="docsWithDrafts"
          [currentWorkingDocId]="currentWorkingDocId"
          [style.width.px]="leftWidth"
          (groupSelected)="selectGroup($event.group, $event.event)"
          (docSelected)="selectDoc($event)"
          (groupToggled)="toggleGroup($event)"
          (groupCreated)="createGroup()"
          (docCreatedInGroup)="createDocInGroup($event)"
          (docDeleted)="deleteDoc($event)"
          (groupDeleted)="deleteGroup($event)"
          (workingDocChanged)="onWorkingDocChanged($event)"
          (docDropped)="onDocDropped($event)"
          (importFoldersRequested)="onImportFoldersRequested()"
          (importFilesRequested)="onImportFilesRequested()"
          (exportProjectRequested)="onExportProjectRequested()"
          (treeKeyDown)="handleTreeKeyDown($event)"
          (widthChanged)="startResizeLeft($event)"
          (collapseToggle)="toggleLeftSidebar()"
          (projectNameEditStart)="startEditProjectName($event)"
          (projectNameSave)="saveProjectName()"
          (projectNameKeydown)="onProjectNameKeydown($event)"
          (backClicked)="goBack()">
        </app-doc-tree>
        }
      </div>
      @if (leftCollapsed) {
        <div class="collapsed-handle collapsed-left" (mousedown)="startDragExpandLeft($event)" title="Drag to expand">
          <span class="divider-grip"></span>
        </div>
      }
    </div>

    <!-- Editor -->
    <main class="editor-area" #editorArea (scroll)="onEditorAreaScroll(editorArea.scrollTop)">
      <!-- Floating headers overlay (visible when triggered by doc header click when scrolled) -->
      @if (headersHoverVisible) {
        <div class="floating-headers-overlay" (click)="onFloatingHeadersClick($event)">
          <!-- Close hint button -->
          <div class="close-hint-btn" (click)="headersHoverVisible = false" title="Press ESC to close">
            <span class="key-hint">ESC</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="close-icon">
              <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
            </svg>
          </div>

          <!-- Project title bar -->
          <div class="project-title-bar floating" (click)="onProjectHeaderClick($event)">
            <div class="project-title-center">
              @if (!editingProjectName) {
                <div class="project-name">
                  <span class="cursor-text" title="Click to rename" (click)="startEditProjectName($event)">{{ projectName }}</span>
                </div>
              } @else {
                <input
                  #projectNameInput
                  class="project-name-input"
                  [(ngModel)]="projectNameEdit"
                  (blur)="saveProjectName()"
                  (keydown)="onProjectNameKeydown($event)"
                  placeholder="Project name" />
              }
            </div>
          </div>
          
          <!-- Project content (folders list) - visible when project header is expanded -->
          @if (projectHeaderExpanded) {
            <div class="project-content floating" (click)="$event.stopPropagation()">
              <!-- Only show folders list when there are multiple parts -->
              @if (docGroups.length > 1) {
                <div class="folders-scroll-container">
                  @for (group of docGroups; track group.id; let i = $index) {
                    <button 
                      class="folder-chip" 
                      [class.selected]="projectHeaderSelectedGroupId === group.id"
                      (click)="onProjectFolderChipClick(group, $event)">
                      <span class="folder-chip-index">{{ i + 1 }}.</span>
                      <span class="folder-chip-name">{{ group.name }}</span>
                    </button>
                  }
                </div>
              }
              @if (docGroups.length === 0) {
                <div class="folders-scroll-container">
                  <span class="no-folders-hint">No folders yet</span>
                </div>
              }
              <!-- Docs cards for selected folder -->
              @if (projectHeaderSelectedGroupId) {
                <div class="folder-docs-row">
                  <div class="docs-cards-container" (wheel)="onDocsContainerWheel($event)">
                    @for (doc of getProjectHeaderSelectedGroupDocs(); track doc.id; let j = $index) {
                      <div class="doc-card" [class.selected]="projectHeaderHighlightedDocId === doc.id" (click)="onProjectDocCardClick(doc, $event)">
                        <div class="doc-card-header">
                          <span class="doc-card-index">{{ j + 1 }}.</span>
                          <span class="doc-card-name">{{ doc.name }}</span>
                        </div>
                        <div class="doc-card-metadata">
                          <!-- Characters row -->
                          <app-metadata-chips
                            [items]="getProjectHeaderDocCharacters(doc.id)"
                            [availableItems]="getAvailableCharactersForDoc(doc.id)"
                            [allItems]="characters"
                            type="character"
                            placeholder="New character..."
                            (remove)="removeCharacterFromDocCard(doc.id, $event)"
                            (add)="addCharacterToDocCard(doc.id, $event)"
                            (create)="createAndAddCharacterToDoc(doc.id, $event)"
                            (deleteItem)="onSidebarCharacterDelete($event)"
                            (editItem)="onInlineCharacterEdit($event)"
                            (reorder)="reorderDocCardCharacters(doc.id, $event)">
                          </app-metadata-chips>

                          <!-- Events row -->
                          <app-metadata-chips
                            [items]="getProjectHeaderDocEvents(doc.id)"
                            [availableItems]="getAvailableEventsForDoc(doc.id)"
                            [allItems]="events"
                            type="event"
                            placeholder="New event..."
                            (remove)="removeEventFromDocCard(doc.id, $event)"
                            (add)="addEventToDocCard(doc.id, $event)"
                            (create)="createAndAddEventToDoc(doc.id, $event)"
                            (deleteItem)="onSidebarEventDelete($event)"
                            (editItem)="onInlineEventEdit($event)"
                            (reorder)="reorderDocCardEvents(doc.id, $event)">
                          </app-metadata-chips>

                          <!-- Places row -->
                          <app-metadata-chips
                            [items]="getProjectHeaderDocPlaces(doc.id)"
                            [availableItems]="getAvailablePlacesForDoc(doc.id)"
                            [allItems]="places"
                            type="place"
                            placeholder="New place..."
                            (remove)="removePlaceFromDocCard(doc.id, $event)"
                            (add)="addPlaceToDocCard(doc.id, $event)"
                            (create)="createAndAddPlaceToDoc(doc.id, $event)"
                            (deleteItem)="onSidebarPlaceDelete($event)"
                            (editItem)="onInlinePlaceEdit($event)"
                            (reorder)="reorderDocCardPlaces(doc.id, $event)">
                          </app-metadata-chips>
                        </div>
                      </div>
                    }
                    @if (getProjectHeaderSelectedGroupDocs().length === 0) {
                      <span class="no-docs-hint">No documents in this folder</span>
                    }
                  </div>
                </div>
              }
            </div>
          }
          
          <!-- Folder title bar -->
          @if (selectedGroup || currentGroup) {
            <div class="folder-title-bar floating" (click)="selectedDoc ? onFolderHeaderClick($event) : null">
              <div class="folder-title-center">
                @if (getFolderIndexLabel()) { <span class="header-index">{{ getFolderIndexLabel() }}.</span> }
                @if (!editingFolderName) {
                  <div class="project-name">
                    <span class="cursor-text" title="Click to rename folder" (click)="startEditFolderName($event)">{{ (selectedGroup || currentGroup)?.name }}</span>
                  </div>
                } @else {
                  <input
                    #folderNameInput
                    class="project-name-input folder-name-input"
                    [(ngModel)]="folderNameEdit"
                    (blur)="saveFolderName()"
                    (keydown)="onFolderNameKeydown($event)"
                    placeholder="Folder name" />
                }
              </div>
            </div>
            
            <!-- Folder drafts - visible when folder header is expanded -->
            @if (folderHeaderExpanded && selectedDoc) {
              <div class="floating-folder-drafts" (click)="$event.stopPropagation()">
                <app-folder-drafts
                  [drafts]="folderDrafts"
                  [selectedDraftId]="selectedFolderDraftId"
                  (draftCreate)="createFolderDraft()"
                  (draftChange)="onFolderDraftChange($event.draftId, $event.content, $event.cursorPosition)"
                  (draftNameChange)="onFolderDraftNameChange($event.draftId, $event.name)"
                  (draftDelete)="deleteFolderDraft($event)"
                  (draftMove)="onFolderDraftMove($event)"
                  (draftSelect)="onFolderDraftSelect($event)">
                </app-folder-drafts>
              </div>
            }
          }
        </div>
      }
      
      <!-- Project/folder headers - shown when viewing a folder OR when doc editor is scrolled to top -->
      <div
        class="inline-headers-wrapper"
        [class.hidden]="selectedDoc && (headersHiddenByScroll || inlineHeadersDismissed)"
        (clickOutside)="onInlineHeadersClickedOutside($event)"
        [clickOutsideEnabled]="!!selectedDoc"
        [clickOutsideEvents]="'click,touchstart'"
        [clickOutsideExclude]="'.floating-headers-overlay,.editor-toolbar,.floating-folder-drafts-dock,.floating-doc-cards-dock,.floating-doc-tools'">
      <!-- Project title bar REMOVED - now accessed via toolbar button -->

      </div> <!-- end .inline-headers-wrapper -->

      <!-- Document editor -->
      @if (selectedDoc && !selectedGroup) {
      <app-document-editor 
        [selectedDoc]="selectedDoc"
        [allProjectDocs]="getAllDocs()"
        [showSaveStatus]="showSaveStatus"
        [hasUnsavedChanges]="hasUnsavedChanges"
        [editorWidthPercent]="editorWidthPercent"
        [drafts]="drafts"
        [draftSyncStatus]="draftSyncStatus"
        [selectedDraftId]="selectedDraftId"
    [externalMode]="selectedProjectDraftId != null"
    [externalDraftId]="selectedProjectDraftId"
  [externalDraftName]="selectedProjectDraftId ? (getSelectedProjectDraftName() ?? 'Draft') : null"
    [externalDraftContent]="selectedProjectDraftId ? getProjectDraftLocalContent(selectedProjectDraftId) : ''"
        [docIndexLabel]="getDocIndexLabel()"
        [folderDraftsCount]="folderDraftsCount"
        [folderNotesExpanded]="folderHeaderExpanded"
        [docCardsExpanded]="projectHeaderExpanded"
        (docNameChange)="renameDoc($event)"
        (docTextChange)="onDocumentTextChange()"
        (docSaved)="saveDoc()"
        (docHeaderClick)="onDocHeaderClick()"
        (editorScroll)="onEditorTextareaScroll($event)"
        (draftRenamed)="onDocumentDraftRenamed($event)"
        (draftAdd)="onDocumentDraftAdd()"
        (draftSelect)="onDocumentDraftSelect($event)"
        (draftChanged)="onDocumentDraftChanged($event)"
        (draftBlurred)="onDocumentDraftBlurred($event)"
        (draftDeleted)="deleteDraft($event)"
        (folderNotesToggle)="onFolderHeaderClick()"
        (docCardsToggle)="toggleDocCardsView()">
      </app-document-editor>
      }

      <!-- Group view -->
      @if (selectedGroup && !selectedDoc) {
      <app-group-view 
        [selectedGroup]="selectedGroup"
        [folderDrafts]="folderDrafts"
        [selectedFolderDraftId]="selectedFolderDraftId"
        [characters]="characters"
        [events]="events"
        [places]="places"
        [docCharactersCache]="projectHeaderDocCharactersCache"
        [docEventsCache]="projectHeaderDocEventsCache"
        [docPlacesCache]="projectHeaderDocPlacesCache"
        (groupNameChange)="renameGroup($event)"
        (createDocRequested)="createDoc()"
        (focusTreeRequested)="focusTree()"
        (notesChanged)="onDocGroupNotesChange()"
        (folderDraftCreate)="createFolderDraft()"
        (folderDraftChange)="onFolderDraftChange($event.draftId, $event.content, $event.cursorPosition)"
        (folderDraftNameChange)="onFolderDraftNameChange($event.draftId, $event.name)"
        (folderDraftDelete)="deleteFolderDraft($event)"
        (folderDraftMove)="onFolderDraftMove($event)"
        (folderDraftSelect)="onFolderDraftSelect($event)"
        (docCardClick)="selectDoc($event)"
        (characterAdd)="addCharacterToDocCard($event.docId, $event.characterId)"
        (characterRemove)="removeCharacterFromDocCard($event.docId, $event.characterId)"
        (characterCreate)="createAndAddCharacterToDoc($event.docId, $event.name)"
        (characterDelete)="onSidebarCharacterDelete($event)"
        (characterEdit)="onInlineCharacterEdit($event)"
        (characterReorder)="reorderDocCardCharacters($event.docId, $event.orderIds)"
        (eventAdd)="addEventToDocCard($event.docId, $event.eventId)"
        (eventRemove)="removeEventFromDocCard($event.docId, $event.eventId)"
        (eventCreate)="createAndAddEventToDoc($event.docId, $event.name)"
        (eventDelete)="onSidebarEventDelete($event)"
        (eventEdit)="onInlineEventEdit($event)"
        (eventReorder)="reorderDocCardEvents($event.docId, $event.orderIds)"
        (placeAdd)="addPlaceToDocCard($event.docId, $event.placeId)"
        (placeRemove)="removePlaceFromDocCard($event.docId, $event.placeId)"
        (placeCreate)="createAndAddPlaceToDoc($event.docId, $event.name)"
        (placeDelete)="onSidebarPlaceDelete($event)"
        (placeEdit)="onInlinePlaceEdit($event)"
        (placeReorder)="reorderDocCardPlaces($event.docId, $event.orderIds)">
      </app-group-view>
      }
      
      <!-- Empty state -->
      @if (!selectedDoc && !selectedGroup) {
      <div class="editor-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" class="empty-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="empty-message">No document selected</p>
        <p class="empty-hint">Create a part and add chapters to start writing</p>
      </div>
      }
    </main>

    <!-- Right Sidebar -->
    <div class="sidebar-container right-sidebar" [style.width.px]="(rightCollapsed || !selectedDoc) ? 6 : rightWidth">
      <div class="sidebar-inner" [style.width.px]="rightWidth">
        @if (!rightCollapsed && selectedDoc) {
        <app-right-sidebar
      [selectedDoc]="selectedDoc"
      [selectedDocGroup]="selectedGroup || currentGroup"
      [project]="projectData"
      [characters]="characters"
      [docCharacterIds]="docCharacterIds"
      [docGroupCharacterIds]="docGroupCharacterIds"
      [events]="events"
      [places]="places"
      [drafts]="drafts"
      [draftSyncStatus]="draftSyncStatus"
      [draftsExpanded]="draftsExpanded"
      [timelineHeaderVisible]="timelineHeaderVisible"
  [editingCharacterId]="editingCharacterId"
  [docEventIds]="docEventIds"
  [docGroupEventIds]="docGroupEventIds"
  [editingEventId]="editingEventId"
  [docPlaceIds]="docPlaceIds"
  [docGroupPlaceIds]="docGroupPlaceIds"
  [editingPlaceId]="editingPlaceId"
      [style.width.px]="rightWidth"
      (draftsExpandedChange)="draftsExpanded = $event"
  (collapseToggle)="toggleRightSidebar()"
      (timelineHeaderToggle)="toggleTimelineHeader()"
    (charactersReorder)="onSidebarCharactersReorder($event)"
    (eventsReorder)="onSidebarEventsReorder($event)"
    (placesReorder)="onSidebarPlacesReorder($event)"
  (characterUpdate)="onSidebarCharacterUpdate($event)"
      (characterAdd)="onSidebarCharacterAdd()"
      (characterCreate)="onSidebarCharacterCreate($event)"
      (characterNameChange)="onSidebarCharacterNameChange($event)"
      (characterDescChange)="onSidebarCharacterDescChange($event)"
      (characterDelete)="onSidebarCharacterDelete($event)"
      (characterToggle)="onSidebarCharacterToggle($event)"
      (docGroupCharacterToggle)="onSidebarDocGroupCharacterToggle($event)"
  (eventAdd)="onSidebarEventAdd()"
      (eventCreate)="onSidebarEventCreate($event)"
  (eventUpdate)="onSidebarEventUpdate($event)"
  (eventDelete)="onSidebarEventDelete($event)"
  (eventToggle)="onSidebarEventToggle($event)"
      (docGroupEventToggle)="onSidebarDocGroupEventToggle($event)"
      (placeAdd)="onSidebarPlaceAdd()"
      (placeCreate)="onSidebarPlaceCreate($event)"
      (placeUpdate)="onSidebarPlaceUpdate($event)"
      (placeDelete)="onSidebarPlaceDelete($event)"
      (placeToggle)="onSidebarPlaceToggle($event)"
      (docGroupPlaceToggle)="onSidebarDocGroupPlaceToggle($event)"
      (docNotesChanged)="onDocumentNotesChange()"
      (docGroupNotesChanged)="onDocGroupNotesChange()"
      (projectNotesChanged)="onProjectNotesChange()"
      (draftCreated)="createDraft()"
      (draftChanged)="onDraftChange($event.draftId, $event.content, $event.cursorPosition)"
      (draftBlurred)="onDraftBlur($event)"
      (draftDeleted)="deleteDraft($event)"
      (draftContentRequested)="getDraftLocalContent($event)"
      (widthChanged)="startResizeRight($event)">
        </app-right-sidebar>
        }
      </div>
      @if (rightCollapsed || !selectedDoc) {
        <div class="collapsed-handle collapsed-right" (mousedown)="startDragExpandRight($event)" title="Drag to expand">
          <span class="divider-grip"></span>
        </div>
      }
    </div>
  </div>

  <!-- Import target folder dialog -->
  @if (showImportDialog) {
    <div class="modal-overlay" (click)="cancelImport()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">Import text files</div>
        <div class="modal-body">
          <div class="mb-2 text-sm text-gray-600">Choose a folder to place the imported documents.</div>
          <select class="modal-select" [(ngModel)]="importTargetGroupId">
            @for (opt of flattenedGroups; track opt.id) {
              <option [ngValue]="opt.id">{{ opt.label }}</option>
            }
          </select>
          @if (pendingImportFiles.length) {
            <div class="mt-3 text-xs text-gray-500">{{ pendingImportFiles.length }} file(s) selected</div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="cancelImport()">Cancel</button>
          <button class="btn-primary" [disabled]="!importTargetGroupId" (click)="confirmImport()">Import</button>
        </div>
      </div>
    </div>
  }
  
  <!-- Inline Delete Confirmations -->
  @if (confirmingDeleteDoc) {
    <div class="inline-confirm-overlay" (click)="cancelDeleteDoc()">
      <div class="inline-confirm-box" (click)="$event.stopPropagation()">
        <div class="inline-confirm-title">Delete Chapter</div>
        <div class="inline-confirm-message">Delete "{{ confirmingDeleteDoc.name }}"?</div>
        <div class="inline-confirm-actions">
          <button class="btn-cancel" (click)="cancelDeleteDoc()">Cancel</button>
          <button class="btn-delete" (click)="confirmDeleteDoc()">Delete</button>
        </div>
      </div>
    </div>
  }
  
  @if (confirmingDeleteGroup) {
    <div class="inline-confirm-overlay" (click)="cancelDeleteGroup()">
      <div class="inline-confirm-box" (click)="$event.stopPropagation()">
        <div class="inline-confirm-title">Delete Part</div>
        <div class="inline-confirm-message">Delete part "{{ confirmingDeleteGroup.name }}" and all its contents?</div>
        <div class="inline-confirm-actions">
          <button class="btn-cancel" (click)="cancelDeleteGroup()">Cancel</button>
          <button class="btn-delete" (click)="confirmDeleteGroup()">Delete</button>
        </div>
      </div>
    </div>
  }
  
  <!-- Global docker component -->
  <app-footer
    [selectedDoc]="selectedDoc"
    [selectedGroup]="selectedGroup"
    [allDocs]="getAllDocs()"
    [leftCollapsed]="leftCollapsed"
    [rightCollapsed]="rightCollapsed"
    [editorWidthPercent]="editorWidthPercent"
    (backToProjects)="goBack()"
    (createGroup)="createGroup()"
    (deleteItem)="deleteSelectedItem()"
    (importFolders)="onImportFoldersRequested()"
    (importFiles)="onImportFilesRequested()"
    (exportProject)="onExportProjectRequested()"
    (toggleLeft)="toggleLeftSidebar()"
    (toggleRight)="toggleRightSidebar()"
    (toggleAll)="toggleBothSidebars()"
    (editorWidthChange)="setEditorWidth($event)"
  ></app-footer>

  <!-- Floating command button -->
  @if (!leftCollapsed) {
    <button class="floating-command-button" title="Project actions" (click)="toggleProjectMenu()">
      <img src="assets/icons/command.svg" alt="Menu" />
    </button>
    
    <!-- Project actions menu -->
    @if (projectMenuVisible) {
      <div class="project-menu" (click)="$event.stopPropagation()">
        <button class="menu-item" (click)="onImportFoldersRequested(); projectMenuVisible = false">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v6m0 0l-3-3m3 3l3-3" />
          </svg>
          <span>Import folders</span>
        </button>
        <button class="menu-item" (click)="onImportFilesRequested(); projectMenuVisible = false">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v6m0 0l-3-3m3 3l3-3" />
          </svg>
          <span>Import files</span>
        </button>
        <button class="menu-item" (click)="onExportProjectRequested(); projectMenuVisible = false">
          <img class="menu-icon" src="assets/icons/square.and.arrow.up.svg" alt="" />
          <span>Export project</span>
        </button>
        <button class="menu-item" (click)="onExportProjectToPdfRequested(); projectMenuVisible = false">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          <span>Export to PDF</span>
        </button>
        <div class="menu-separator"></div>
        <button class="menu-item" (click)="openCommandPalette('search-doc'); projectMenuVisible = false">
          <img class="menu-icon" src="assets/icons/magnifyingglass.circle.svg" alt="" />
          <span>Search in chapter</span>
          <span class="menu-shortcut">⌘F</span>
        </button>
        <button class="menu-item" (click)="openCommandPalette('search-project'); projectMenuVisible = false">
          <img class="menu-icon" src="assets/icons/rectangle.and.text.magnifyingglass.svg" alt="" />
          <span>Search all chapters</span>
          <span class="menu-shortcut">⌘⇧F</span>
        </button>
        <button class="menu-item" (click)="openCommandPalette('search-replace'); projectMenuVisible = false">
          <img class="menu-icon" src="assets/icons/arrow.2.squarepath.svg" alt="" />
          <span>Search & replace</span>
          <span class="menu-shortcut">⌘H</span>
        </button>
      </div>
    }
  }

  <!-- Floating sidebar controls -->
  <div class="floating-sidebar-controls">
    <button class="sidebar-control-button" [class.active]="!leftCollapsed" title="Toggle tree (⌘1)" (click)="toggleLeftSidebar()">
      <img src="assets/icons/sidebar.left.svg" alt="Left sidebar" />
    </button>
    <button class="sidebar-control-button" [class.active]="leftCollapsed && rightCollapsed" title="Full width (⌘2)" (click)="toggleBothSidebars()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4h4M20 8V4h-4M4 16v4h4M20 16v4h-4" />
      </svg>
    </button>
    <button class="sidebar-control-button" [class.active]="!rightCollapsed" title="Toggle sidebar (⌘3)" (click)="toggleRightSidebar()">
      <img src="assets/icons/sidebar.right.svg" alt="Right sidebar" />
    </button>
  </div>

  <!-- Command Palette -->
  @if (commandPaletteOpen) {
    <app-command-palette
      [isOpen]="commandPaletteOpen"
      [docs]="getAllDocs()"
      [groups]="docGroups"
      [currentDocId]="selectedDoc?.id ?? null"
      [currentDocText]="selectedDoc?.text ?? ''"
      (close)="closeCommandPalette()"
      (navigateToDoc)="onCommandPaletteNavigateToDoc($event)"
      (navigateToDocAtPosition)="onCommandPaletteNavigateToDocAtPosition($event)"
      (replaceInCurrentDoc)="onCommandPaletteReplaceInCurrentDoc($event)"
      (focusEditorAtPosition)="onCommandPaletteFocusEditorAtPosition($event)">
    </app-command-palette>
  }
</div>
