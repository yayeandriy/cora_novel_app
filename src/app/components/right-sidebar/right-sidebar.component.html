<aside class="right-sidebar">
  <div class="resize-handle right" (mousedown)="startResize($event)" (dblclick)="onToggleCollapse()">
    <span class="divider-grip"></span>
  </div>
  
  <!-- Tabs Navigation -->
  <div class="tabs-nav">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'doc'"
      (click)="switchTab('doc')">
      Doc
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'folder'"
      (click)="switchTab('folder')">
      Folder
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'project'"
      (click)="switchTab('project')">
      Project
    </button>
  </div>

  <div class="sidebar-content">
    <!-- DOC TAB CONTENT -->
    @if (activeTab === 'doc') {
      <!-- Characters Section -->
      <div class="sidebar-section">
        <div class="section-header">
          <div class="section-title">
            <span>Characters</span>
          </div>
        </div>
          <app-metadata-chips
            [items]="getAttachedCharacters()"
            [availableItems]="getAvailableCharacters()"
            [allItems]="characters"
            type="character"
            placeholder="New character..."
            (remove)="removeCharacter($event)"
            (add)="addCharacter($event)"
            (deleteItem)="deleteCharacter($event)"
            (editItem)="editCharacter($event)"
            (create)="createAndAddCharacter($event)"
            (reorder)="onReorderCharacters($event)">
          </app-metadata-chips>
      </div>

      <!-- Events Section -->
      <div class="sidebar-section">
        <div class="section-header">
          <div class="section-title">
            <span>Events</span>
          </div>
        </div>
          <app-metadata-chips
            [items]="getAttachedEvents()"
            [availableItems]="getAvailableEvents()"
            [allItems]="events"
            type="event"
            placeholder="New event..."
            (remove)="removeEvent($event)"
            (add)="addEvent($event)"
            (deleteItem)="deleteEvent($event)"
            (editItem)="editEvent($event)"
            (create)="createAndAddEvent($event)"
            (reorder)="onReorderEvents($event)">
          </app-metadata-chips>
      </div>

      <!-- Places Section -->
      <div class="sidebar-section">
        <div class="section-header">
          <div class="section-title">
            <span>Places</span>
          </div>
        </div>
          <app-metadata-chips
            [items]="getAttachedPlaces()"
            [availableItems]="getAvailablePlaces()"
            [allItems]="places"
            type="place"
            placeholder="New place..."
            (remove)="removePlace($event)"
            (add)="addPlace($event)"
            (deleteItem)="deletePlace($event)"
            (editItem)="editPlace($event)"
            (create)="createAndAddPlace($event)"
            (reorder)="onReorderPlaces($event)">
          </app-metadata-chips>
      </div>
    }

    <!-- FOLDER TAB CONTENT -->
    @if (activeTab === 'folder') {
      <!-- Notes Section for Folder (first) -->
      <div class="sidebar-section">
        <div class="section-header">
          <div class="section-title">
            <span>Folder Notes</span>
          </div>
        </div>
        
        @if (selectedDocGroup) {
          <div class="section-content">
            <textarea 
              class="notes-textarea"
              [persistTextareaHeight]="'rs:notes:folder:' + selectedDocGroup.project_id"
              [(ngModel)]="selectedDocGroup.notes"
              (input)="onDocGroupNotesChange()"
              placeholder="Add folder notes..."></textarea>
          </div>
        }
        @if (!selectedDocGroup) {
          <div class="section-content">
            <p style="font-size: 0.875rem; color: #9ca3af; padding: 0.5rem;">Select a folder to add notes</p>
          </div>
        }
      </div>

      <!-- Characters Section for Folder -->
      <app-characters-panel
        [characters]="characters"
        [docCharacterIds]="docGroupCharacterIds"
        [selectedDoc]="selectedDocGroup"
        [editingCharacterId]="editingCharacterId"
        (add)="onCharacterAdd()"
        (createCharacter)="onCharacterCreate($event)"
        (update)="onCharacterUpdate($event)"
        (remove)="onCharacterDelete($event)"
        (toggle)="onDocGroupCharacterToggle($event.characterId, $event)"
        (reorder)="charactersReorder.emit($event)">
      </app-characters-panel>

      <!-- Events Section for Folder -->
      <app-events-panel
        [events]="events"
        [docEventIds]="docGroupEventIds"
        [selectedDoc]="null"
        [editingEventId]="editingEventId"
        [timelineHeaderVisible]="timelineHeaderVisible"
        (add)="eventAdd.emit()"
        (createEvent)="onEventCreate($event)"
        (update)="eventUpdate.emit($event)"
        (remove)="eventDelete.emit($event)"
        (toggle)="onDocGroupEventToggle($event.eventId, $event)"
        (reorder)="eventsReorder.emit($event)"
        (timelineHeaderToggle)="onTimelineHeaderToggle()">
      </app-events-panel>

      <!-- Places Section for Folder -->
      <app-places-panel
        [places]="places"
        [docPlaceIds]="docGroupPlaceIds"
        [selectedDoc]="null"
        [editingPlaceId]="editingPlaceId"
        (add)="onPlaceAdd()"
        (createPlace)="onPlaceCreate($event)"
        (update)="onPlaceUpdate($event)"
        (remove)="onPlaceDelete($event)"
        (toggle)="onDocGroupPlaceToggle($event.placeId, $event)"
        (reorder)="placesReorder.emit($event)">
      </app-places-panel>
    }

    <!-- PROJECT TAB CONTENT -->
    @if (activeTab === 'project') {
      <!-- Notes Section for Project (first) -->
      <div class="sidebar-section">
        <div class="section-header">
          <div class="section-title">
            <span>Project Notes</span>
          </div>
        </div>
        
          <div class="section-content">
            @if (project) {
              <textarea 
                class="notes-textarea"
                [persistTextareaHeight]="'rs:notes:project:' + project.id"
                [(ngModel)]="project.notes"
                (input)="onProjectNotesChange()"
                placeholder="Add project notes..."></textarea>
            }
          </div>
      </div>

      <!-- Characters Section for Project -->
      <app-characters-panel
        [characters]="characters"
        [docCharacterIds]="null"
        [selectedDoc]="null"
        [editingCharacterId]="editingCharacterId"
        (add)="onCharacterAdd()"
        (update)="onCharacterUpdate($event)"
        (remove)="onCharacterDelete($event)"
        (reorder)="charactersReorder.emit($event)">
      </app-characters-panel>

      <!-- Events Section for Project -->
      <app-events-panel
        [events]="events"
        [docEventIds]="null"
        [selectedDoc]="null"
        [editingEventId]="editingEventId"
        [timelineHeaderVisible]="timelineHeaderVisible"
        (add)="eventAdd.emit()"
        (createEvent)="onEventCreate($event)"
        (update)="eventUpdate.emit($event)"
        (remove)="eventDelete.emit($event)"
        (reorder)="eventsReorder.emit($event)"
        (timelineHeaderToggle)="onTimelineHeaderToggle()">
      </app-events-panel>

      <!-- Places Section for Project -->
      <app-places-panel
        [places]="places"
        [docPlaceIds]="null"
        [selectedDoc]="null"
        [editingPlaceId]="editingPlaceId"
        (add)="onPlaceAdd()"
        (createPlace)="onPlaceCreate($event)"
        (update)="onPlaceUpdate($event)"
        (remove)="onPlaceDelete($event)"
        (reorder)="placesReorder.emit($event)">
      </app-places-panel>
    }
  </div>
</aside>
