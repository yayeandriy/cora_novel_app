<div class="metadata-row" cdkDropList cdkDropListOrientation="mixed" (cdkDropListDropped)="onDrop($event)">
  @for (item of items; track item.id) {
    <span class="metadata-chip" [ngClass]="getChipClass()" cdkDrag>
      {{ item.name }}
      <button class="chip-delete-btn" (click)="onRemove(item.id, $event)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811a1 1 0 0 0-1.414 1.414L10.586 12 4.81 17.775a1 1 0 1 0 1.414 1.414L12 13.414l5.775 5.775a1 1 0 0 0 1.414-1.414L13.414 12l5.775-5.775a1 1 0 0 0-1.414-1.414L12 10.586 6.225 4.81Z"/></svg>
      </button>
    </span>
  }
  @if (items.length === 0) {
    <button class="add-metadata-btn add-empty" [ngClass]="getAddBtnClass()" (click)="toggleDropdown($event)" title="Add {{ type }}">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" /></svg>
      <span class="add-label">add {{ type }}</span>
    </button>
  } @else {
    <button class="add-metadata-btn" [ngClass]="getAddBtnClass()" (click)="toggleDropdown($event)" title="Add or edit items">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z" /></svg>
    </button>
  }
</div>

<!-- Dropdown Backdrop -->
@if (dropdownVisible) {
  <div class="dropdown-backdrop" (click)="closeDropdown()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;"></div>
}

<!-- Dropdown -->
@if (dropdownVisible) {
  <div class="add-metadata-dropdown" 
       [style.top.px]="dropdownPosition.top" 
       [style.left.px]="dropdownPosition.left"
       (click)="$event.stopPropagation()">
    
    <div class="dropdown-create-row">
      <input 
        #createInput
        type="text" 
        class="dropdown-create-input" 
        [placeholder]="placeholder"
        (keydown.enter)="$event.preventDefault(); onCreate(createInput.value); createInput.value = ''"
        autofocus />
    </div>
    
    @for (item of dropdownItems; track item.id) {
      <div class="dropdown-item-wrapper" [class.assigned]="isItemAssigned(item.id)">
        @if (editingItemId === item.id) {
          <input 
            #editInput
            type="text" 
            class="dropdown-edit-input"
            [(ngModel)]="editingItemName"
            (keydown.enter)="$event.preventDefault(); saveEdit($event)"
            (keydown.escape)="$event.preventDefault(); cancelEdit($event)"
            (blur)="saveEdit($event)"
            autofocus />
        } @else {
          <button class="dropdown-item" [class.assigned]="isItemAssigned(item.id)" (click)="onAdd(item.id)">
            @if (isItemAssigned(item.id)) {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 0.875rem; height: 0.875rem; margin-right: 0.25rem;">
                <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" />
              </svg>
            }
            {{ item.name }}
          </button>
          <button class="dropdown-edit-btn" (click)="startEdit(item, $event)" title="Edit name">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 1rem; height: 1rem;">
              <path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z" />
            </svg>
          </button>
          <button class="dropdown-delete-btn" (click)="onDeleteItem(item.id, $event)" title="Delete from system">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 1rem; height: 1rem;">
              <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 10-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z" clip-rule="evenodd" />
            </svg>
          </button>
        }
      </div>
    }
    
    @if (dropdownItems.length === 0) {
      <span class="dropdown-empty">No items</span>
    }
  </div>
}
