@if (isOpen) {
  <div class="command-palette-backdrop" (click)="closePanel()">
    <div class="command-palette" (click)="$event.stopPropagation()">
      <!-- Header with mode label and back button -->
      <div class="command-palette-header">
        @if (mode !== 'commands') {
          <button class="back-btn" (click)="goBack()" title="Back to commands">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="back-icon">
              <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
            </svg>
          </button>
        }
        <span class="mode-label">{{ getModeLabel() }}</span>
        <button class="close-btn" (click)="closePanel()" title="Close (ESC)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
          </svg>
        </button>
      </div>

      <!-- Search input -->
      <div class="command-palette-input-row">
        <div class="search-input-wrapper">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
          </svg>
          <input
            #searchInput
            type="text"
            class="command-palette-input"
            [placeholder]="getPlaceholder()"
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()"
            autocomplete="off"
            spellcheck="false" />
          <button 
            class="case-toggle" 
            [class.active]="caseSensitive"
            (click)="toggleCaseSensitive()"
            title="Match case">
            Aa
          </button>
        </div>
      </div>

      <!-- Replace input (only in search-replace mode) -->
      @if (mode === 'search-replace') {
        <div class="command-palette-input-row replace-row">
          <div class="search-input-wrapper">
            <svg class="search-icon replace-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311h2.433a.75.75 0 000-1.5H3.989a.75.75 0 00-.75.75v4.242a.75.75 0 001.5 0v-2.43l.312.312a7 7 0 0011.712-3.138.75.75 0 00-1.451-.39zm1.938-5.174a.75.75 0 00-1.5 0v2.43l-.312-.312a7 7 0 00-11.712 3.138.75.75 0 001.451.39 5.5 5.5 0 019.201-2.466l.312.311h-2.433a.75.75 0 000 1.5h4.243a.75.75 0 00.75-.75V6.25z" clip-rule="evenodd" />
            </svg>
            <input
              #replaceInput
              type="text"
              class="command-palette-input"
              placeholder="Replace with..."
              [(ngModel)]="replaceQuery"
              autocomplete="off"
              spellcheck="false" />
          </div>
          <div class="replace-actions">
            <button class="replace-btn" (click)="replaceOne()" [disabled]="!searchQuery || currentDocMatches.length === 0" title="Replace next">
              Replace
            </button>
            <button class="replace-btn replace-all" (click)="replaceAll()" [disabled]="!searchQuery" title="Replace all occurrences">
              Replace All
            </button>
          </div>
        </div>
      }

      <!-- Results -->
      <div class="command-palette-results">
        <!-- Commands mode -->
        @if (mode === 'commands') {
          @if (filteredCommands.length > 0) {
            <div class="results-section">
              <div class="section-label">Commands</div>
              @for (cmd of filteredCommands; track cmd.id; let i = $index) {
                <div 
                  class="command-palette-item"
                  [class.selected]="selectedIndex === i"
                  (click)="selectCommand(cmd)"
                  (mouseenter)="selectedIndex = i">
                  <span class="item-icon">{{ cmd.icon }}</span>
                  <span class="item-label">{{ cmd.label }}</span>
                  @if (cmd.shortcut) {
                    <span class="item-shortcut">{{ cmd.shortcut }}</span>
                  }
                </div>
              }
            </div>
          }
          @if (filteredDocs.length > 0) {
            <div class="results-section">
              <div class="section-label">Documents</div>
              @for (doc of filteredDocs; track doc.id; let i = $index) {
                <div 
                  class="command-palette-item"
                  [class.selected]="selectedIndex === filteredCommands.length + i"
                  (click)="selectDoc(doc)"
                  (mouseenter)="selectedIndex = filteredCommands.length + i">
                  <span class="item-icon">ðŸ“„</span>
                  <span class="item-label">{{ doc.name }}</span>
                  @if (doc.groupName) {
                    <span class="item-group">{{ doc.groupName }}</span>
                  }
                </div>
              }
            </div>
          }
          @if (filteredCommands.length === 0 && filteredDocs.length === 0) {
            <div class="no-results">No results found</div>
          }
        }

        <!-- Search in current doc mode -->
        @if (mode === 'search-doc' || mode === 'search-replace') {
          @if (searchQuery && currentDocMatches.length > 0) {
            <div class="results-section">
              <div class="section-label">{{ currentDocMatches.length }} match{{ currentDocMatches.length !== 1 ? 'es' : '' }} found</div>
              @for (match of currentDocMatches; track $index; let i = $index) {
                <div 
                  class="command-palette-item match-item"
                  [class.selected]="selectedIndex === i"
                  (click)="selectMatch(i)"
                  (mouseenter)="selectedIndex = i">
                  <span class="line-number">Line {{ match.lineNumber }}</span>
                  <span class="line-text" [innerHTML]="highlightMatch(match.lineText, match.matchStart, match.matchEnd)"></span>
                </div>
              }
            </div>
          }
          @if (searchQuery && currentDocMatches.length === 0) {
            <div class="no-results">No matches found in current document</div>
          }
          @if (!searchQuery) {
            <div class="no-results hint">Type to search in the current document</div>
          }
        }

        <!-- Search in project mode -->
        @if (mode === 'search-project') {
          @if (searchQuery && searchResults.length > 0) {
            @for (result of searchResults; track result.docId; let ri = $index) {
              <div class="results-section">
                <div class="section-label doc-result-header">
                  <span class="doc-icon">ðŸ“„</span>
                  <span class="doc-name">{{ result.docName }}</span>
                  @if (result.groupName) {
                    <span class="doc-group">{{ result.groupName }}</span>
                  }
                  <span class="match-count">{{ result.matches.length }} match{{ result.matches.length !== 1 ? 'es' : '' }}</span>
                </div>
                @for (match of result.matches; track $index; let mi = $index) {
                  <div 
                    class="command-palette-item match-item"
                    [class.selected]="selectedIndex === getAbsoluteIndex(ri, mi)"
                    (click)="selectProjectMatch(result.docId, mi, getAbsoluteIndex(ri, mi))"
                    (mouseenter)="selectedIndex = getAbsoluteIndex(ri, mi)">
                    <span class="line-number">Line {{ match.lineNumber }}</span>
                    <span class="line-text" [innerHTML]="highlightMatch(match.lineText, match.matchStart, match.matchEnd)"></span>
                  </div>
                }
              </div>
            }
          }
          @if (searchQuery && searchResults.length === 0) {
            <div class="no-results">No matches found in project</div>
          }
          @if (!searchQuery) {
            <div class="no-results hint">Type to search across all documents</div>
          }
        }
      </div>

      <!-- Footer hints -->
      <div class="command-palette-footer">
        <span class="hint-item"><kbd>â†‘</kbd><kbd>â†“</kbd> Navigate</span>
        <span class="hint-item"><kbd>Enter</kbd> Select</span>
        <span class="hint-item"><kbd>Esc</kbd> Close</span>
        @if (mode === 'search-replace') {
          <span class="hint-item"><kbd>Tab</kbd> Switch fields</span>
        }
      </div>
    </div>
  </div>
}
